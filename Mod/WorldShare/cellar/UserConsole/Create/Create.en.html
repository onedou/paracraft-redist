<html>
    <body>
        <pe:mcml>
            <script type="text/npl" refresh="false">
                <![CDATA[
                    -- lib
                    local KpUserTag = NPL.load("(gl)script/apps/Aries/Creator/Game/mcml/keepwork/KpUserTag.lua")

                    local InternetLoadWorld = commonlib.gettable("MyCompany.Aries.Creator.Game.Login.InternetLoadWorld")
                    local UniString = commonlib.gettable("System.Core.UniString")

                    -- UI
                    local UserConsoleCreate = NPL.load("./Create.lua")
                    local UserConsole = NPL.load("(gl)Mod/WorldShare/cellar/UserConsole/Main.lua")
                    local WorldList = NPL.load("(gl)Mod/WorldShare/cellar/UserConsole/WorldList.lua")
                    local UserInfo = NPL.load("(gl)Mod/WorldShare/cellar/UserConsole/UserInfo.lua")

                    local page = document:GetPageCtrl()
                    Mod.WorldShare.Store:Remove("world/searchText")

                    UIAnimManager.LoadUIAnimationFile("script/UIAnimation/CommonProgress.lua.table")

                    local do_modify = false
                    local current_item_index = 1
                    local temp_modify_worldname = ''
                    local current_menu_index = 1

                    function is_modifying()
                        return do_modify
                    end

                    function covert_status()
                        local currentWorld = Mod.WorldShare.Store:Get('world/currentWorld')
                        local currentEnterWorld = Mod.WorldShare.Store:Get('world/currentEnterWorld')

                        if currentEnterWorld and currentEnterWorld.foldername == currentWorld.foldername then
                            GameLogic.AddBBS(nil, L"不能重命名当前编辑的世界", 3000, "255 0 0")
                            return false
                        end

                        if do_modify then
                            -- update world name

                            if UserConsole:WorldRename(
                                current_item_index,
                                temp_modify_worldname,
                                function()
                                    WorldList:RefreshCurrentServerList(function()
                                        switch_world(current_item_index)
                                    end)
                                end
                            ) then
                                temp_modify_worldname = ''
                            else
                                temp_modify_worldname = ''
                                do_modify = not do_modify
                                page:Refresh(0.01)
                            end

                            return true
                        end

                        do_modify = not do_modify
                        page:Refresh(0.01)
                    end

                    function be_selected()
                        return Eval("index") == WorldList.worldIndex
                    end

                    function get_world_status(index)
                        return UserInfo.IsSignedIn() and not WorldList.GetCurWorldInfo("is_zip", Eval("index")) and WorldList.GetCurWorldInfo("status", Eval("index")) == index;
                    end

                    function get_world_status_icon(index)
                        if(index == 1) then
                            return 'background:url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#72 104 16 16)';
                        end

                        if(index == 2) then
                            return 'background:url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#98 104 16 16)';
                        end

                        if(index == 3) then
                            return 'background:url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#20 104 16 16)';
                        end

                        if(index == 4) then
                            return 'background:url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#46 104 16 16)';
                        end

                        if(index == 5) then
                            return 'background:url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#124 104 16 16)';
                        end
                    end

                    function get_world_status_tips()
                        return WorldList.FormatStatus(WorldList.GetCurWorldInfo("status",Eval("index")));
                    end

                    function get_share_button(style)
                        if style == 'folder' then
                            return 'background:url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#392 50 38 38)';
                        end

                        if style == 'delete' then
                            return 'background:url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#348 50 38 38)';
                        end

                        if style == 'sync' then
                            return 'background:url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#437 50 38 38)';
                        end

                        if style == 'enter' then
                            return 'background:url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#419 10 38 38)';
                        end

                        if style == 'web' then
                            return 'background:url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#65 459 38 39)';
                        end

                        if style == 'revision' then
                            return 'background:url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#19 460 38 38)';
                        end
                    end

                    function header()
                        return 'height:34px;\
                                width: 300px;\
                                margin:2px;\
                                margin-top:5px;\
                                margin-left:5px;\
                                margin-bottom:0px';
                    end

                    function get_world_version()
                        return WorldList.GetCurWorldInfo("revision", Eval("index")) or 0
                    end

                    function get_world_size()
                        return Mod.WorldShare.Utils.FormatFileSize(WorldList.GetLatestSize(Eval("index")))
                    end

                    function can_be_sync()
                        return UserInfo.IsSignedIn() and not WorldList.GetCurWorldInfo("is_zip", Eval("index"))
                    end

                    function get_world_date()
                        return WorldList.FormatDatetime(WorldList.GetCurWorldInfo("modifyTime", Eval("index")))
                    end

                    function selected_version(index)
                        WorldList:SelectVersion(tonumber(index))
                    end

                    function go_to_url()
                        local url = Page:GetValue("content","");

                        local pid = UserConsole:GetProjectId(url)

                        if pid then
                            UserConsole:HandleWorldId(pid)
                        else
                            InternetLoadWorld.GotoUrl(url)
                        end
                    end

                    function refresh()
                        WorldList:RefreshCurrentServerList()
                    end

                    function username()
                        local userType = Mod.WorldShare.Store:Get('user/userType')
                        local isVip = Mod.WorldShare.Store:Get('user/isVip')
                        local username = UserInfo.GetUserName()
                        local textWidth = _guihelper.GetTextWidth(username)

                        local styleStr = ''

                        local user_info = {}
                        local count = 0

                        if userType.teacher then
                            user_info.tLevel = 1
                            count = count + 1
                            end
                            
                        if userType.student then
                            user_info.student = 1
                            count = count + 1
                        end
                            
                        if isVip then
                            user_info.vip = 1
                            count = count + 1
                        end

                        styleStr = KpUserTag.GetMcml(user_info)

                        if not styleStr or styleStr == "" then
                            styleStr = styleStr ..  '<div style="text-align: center">' .. username .. '</div>'
                        else
                            local margin_left = 0

                            if count >= 2 then
                                count = 2
                            end

                            margin_left = (140 - textWidth - 2 - 18 * count) / 2

                            styleStr = '<div style="float: left;margin-left: ' .. margin_left .. 'px;margin-top: 2px;">' .. styleStr .. '</div>' .. '<div style="float: left;margin-left: 2px;">' .. username .. '</div>'
                        end

                        return styleStr
                    end

                    function logout()
                        UserInfo:Logout()
                    end

                    function close()
                        if System.options.mc == true then
                            if Mod.WorldShare.Store:Get("world/isEnterWorld") then
                                UserConsole:ClosePage()
                            else
                                if is_signed_in() then
                                    logout()
                                end

                                UserConsole:ClosePage()
                                UserConsole:EnterMainLogin()
                            end
                        else
                            UserConsole:ClosePage()
                        end
                    end

                    function is_list_refreshing()
                        return WorldList:IsRefreshing()
                    end

                    function switch_world(index)
                        do_modify = false
                        current_item_index = index
                        WorldList:OnSwitchWorld(index)
                    end

                    function is_signed_in()
                        return UserInfo.IsSignedIn()
                    end

                    function delete_world(index)
                        WorldList:DeleteWorld(index)
                    end

                    function sync(index)
                        WorldList:Sync(index)
                    end

                    function enter(index)
                        WorldList:EnterWorld(index)
                    end

                    function create_new_world()
                        UserConsole:CreateNewWorld()
                    end

                    function get_world_text()
                        if type(Eval("text")) ~= 'string' then
                            return ''
                        end

                        local text = Eval("text")

                        if _guihelper.GetTextWidth(text) > 150 then
                            local function chsize(char)
                                if not char then
                                    return 0
                                elseif char > 240 then
                                    return 4
                                elseif char > 225 then
                                    return 3
                                elseif char > 192 then
                                    return 2
                                else
                                    return 1
                                end
                            end

                            local len = 0
                            local count = 0
                            local currentIndex = 1

                            while currentIndex <= #text do
                                local charsizenum = chsize(string.byte(text, currentIndex))

                                currentIndex = currentIndex + charsizenum

                                if len >= 25 then
                                    break
                                end

                                if charsizenum ~= 0 then
                                    count = count + 1

                                    if charsizenum >= 3 then
                                        len = len + 3.2
                                    else
                                        len = len + 1.5
                                    end
                                end
                            end

                            text = UniString:new(text):sub(1, count).text .. '...'
                        end

                        if Eval("is_zip") == true then
                            text = text .. '.zip'
                        end

                        return text
                    end

                    function open_project(index)
                        WorldList:OpenProject(index)
                    end

                    function update_temp_modify_worldname(name, mcmlNode)
                        temp_modify_worldname = mcmlNode:GetUIValue()
                    end

                    function get_tagname()
                        if Eval("local_tagname") and Eval("local_tagname") ~= "" then
                            return Eval("local_tagname")
                        else
                            return Eval("remote_tagname")
                        end
                    end

                    function search()
                        local search_text = ''
 
                        if is_signed_in() then
                            search_text = page:GetValue('search_text_online')
                        else
                            search_text = page:GetValue('search_text_offline')
                        end

                        if type(search_text) == "string" then
                            Mod.WorldShare.Store:Set("world/searchText", search_text)
                            refresh()
                        end
                    end

                    function get_last_search_text()
                        local searchText = Mod.WorldShare.Store:Get("world/searchText")

                        if type(searchText) == "string" and searchText ~= "" then
                            return searchText
                        end
                    end

                    function is_current_menu_select(index)
                        if tonumber(index) == tonumber(UserConsoleCreate.currentMenuSelectIndex) then
                            return true
                        else
                            return false
                        end
                    end

                    function select_type(index)
                        UserConsoleCreate.currentMenuSelectIndex = index

                        if not index or (type(index) ~= 'string' and type(index) ~= 'number') then
                            return false
                        end

                        index = tonumber(index)
                        local statusFilter

                        if index == 1 then
                            WorldList:RefreshCurrentServerList(function() page:Refresh(0.01) end)
                        elseif index == 2 then
                            WorldList:RefreshCurrentServerList(function() page:Refresh(0.01) end, 'ONLINE')
                        elseif index == 3 then
                            WorldList:RefreshCurrentServerList(function() page:Refresh(0.01) end, 'LOCAL')
                        end
                    end

                    function get_art_number()
                        local project = Eval('project')

                        if not project or
                           type(project) ~= "table" or
                           not project.rate or
                           type(project.rate) ~= "number" or
                           project.rate == 0 then
                            return ""
                        end

                        local number = project.rate
                        local n = math.floor(1)
                        local fmt = '%.' .. n .. 'f'
                        local nRet = tonumber(string.format(fmt, number))

                        number = tostring(nRet)

                        local returnString = ""

                        for item in string.gmatch(number, ".") do
                            if item == "1" then
                                returnString = returnString .. "<img style='width: 11px;height: 18px;' src='Texture/Aries/Creator/keepwork/worldshare_32bits.png;108 287 11 18' />"
                            end

                            if item == "2" then
                                returnString = returnString .. "<img style='width: 14px;height: 18px;' src='Texture/Aries/Creator/keepwork/worldshare_32bits.png;122 287 14 18' />"
                            end

                            if item == "3" then
                                returnString = returnString .. "<img style='width: 11px;height: 20px;' src='Texture/Aries/Creator/keepwork/worldshare_32bits.png;139 286 11 20' />"
                            end

                            if item == "4" then
                                returnString = returnString .. "<img style='width: 14px;height: 18px;' src='Texture/Aries/Creator/keepwork/worldshare_32bits.png;152 287 15 18' />"
                            end
                            
                            if item == "5" then
                                returnString = returnString .. "<img style='width: 14px;height: 19px;' src='Texture/Aries/Creator/keepwork/worldshare_32bits.png;170 287 15 19' />"
                            end

                            if item == "6" then
                                returnString = returnString .. "<img style='width: 14px;height: 19px;' src='Texture/Aries/Creator/keepwork/worldshare_32bits.png;188 287 14 19' />"
                            end

                            if item == "7" then
                                returnString = returnString .. "<img style='width: 14px;height: 18px;' src='Texture/Aries/Creator/keepwork/worldshare_32bits.png;204 287 14 18' />"
                            end
                                
                            if item == "8" then
                                returnString = returnString .. "<img style='width: 15px;height: 19px;' src='Texture/Aries/Creator/keepwork/worldshare_32bits.png;221 287 15 19' />"
                            end
                                
                            if item == "9" then
                                returnString = returnString .. "<img style='width: 13px;height: 19px;' src='Texture/Aries/Creator/keepwork/worldshare_32bits.png;257 287 13 19' />"
                            end

                            if item == "0" then
                                returnString = returnString .. "<img style='width: 15px;height: 19px;' src='Texture/Aries/Creator/keepwork/worldshare_32bits.png;238 287 15 19' />"
                            end
                                
                            if item == "." then
                                returnString = returnString .. "<img style='width: 6px;height: 7px;margin-top: 11px;margin-right: 2px;' src='Texture/Aries/Creator/keepwork/worldshare_32bits.png;273 293 6 7' />"
                            end
                        end

                        return returnString
                    end

                    function get_world_preview(worldpath)
                        local status = Eval("status")

                        if tonumber(status) == 2 then
                            local project = Eval("project")

                            if not project or
                               type(project) ~= "table" or
                               not project.extra or
                               type(project.extra) ~= "table" or
                               not project.extra.imageUrl or
                               type(project.extra.imageUrl) ~= "string" then
                                return ""
                            end

                            return project.extra.imageUrl
                        else
                            local worldpath = Eval('worldpath')

                            if not worldpath or type(worldpath) ~= "string" then
                                return ""
                            end
                            
                            return worldpath .. "preview.jpg"
                        end
                    end

                    function get_school_name()
                        local user = Eval('user')

                        if not user or type(user) ~= "table" then
                            return ""
                        end

                        if user.school and user.school.name then
                            return user.school.name
                        else
                            return ""
                        end
                    end

                    function get_username()
                        local user = Eval('user')

                        if not user or type(user) ~= "table" then
                            return "<%= '暂无' %>"
                        end

                        if user.username then
                            return user.username
                        else
                            return "<%= '暂无' %>"
                        end
                    end

                    function has_username()
                        local user = Eval('user')

                        if not user or type(user) ~= "table" or not user.username then
                            return false
                        end

                        return true
                    end

                    function get_user_icon()
                        local user = Eval('user')

                        if not user or type(user) ~= "table" then
                            return ""
                        end

                        local user_info = {}
                        local count = 0

                        if user and user.tLevel and type(user.tLevel) == 'number' and user.tLevel >= 1 then
                            user_info.tLevel = 1
                            count = count + 1
                        end
                            
                        if user and user.student and type(user.student) == 'number' and user.student == 1 then
                            user_info.student = 1
                            count = count + 1
                        end
                            
                        if user and user.vip and type(user.vip) == 'number' and user.vip == 1 then
                            user_info.vip = 1
                            count = count + 1
                        end

                        return KpUserTag.GetMcml(user_info)
                    end

                    function get_project_views()
                        local project = Eval('project')

                        if not project or type(project) ~= "table" then
                            return 0
                        end

                        if project.visit and type(project.visit) == "number" then
                            return project.visit
                        else
                            return 0
                        end
                    end

                    function get_project_thumbs()
                        local project = Eval('project')

                        if not project or type(project) ~= "table" then
                            return 0
                        end

                        if project.star and type(project.star) == "number" then
                            return project.star
                        else
                            return 0
                        end
                    end

                    function get_project_comments()
                        local project = Eval('comment')

                        if not project or type(project) ~= "table" then
                            return 0
                        end

                        if project.comment and type(project.comment) == "number" then
                            return project.comment
                        else
                            return 0
                        end
                    end

                    function has_rated()
                        local project = Eval('project')

                        if not project or type(project) ~= "table" then
                            return false
                        end

                        if project.rate and type(project.rate) == "number" and project.rate > 0 then
                            return true
                        else
                            return false
                        end
                    end

                    function get_user_avatar()
                        local user = Eval('user')

                        if not user or type(user) ~= "table" then
                            return ""
                        end

                        if user.portrait and type(user.portrait) == "string" then
                            return "<div style='float: left;margin-left: 2px;margin-right: 2px;width: 18px;height: 18px;background-color: #ffffff'><img style='width: 18px;height: 18px;' src='" .. user.portrait .. "' /></div>"
                        else
                            return ""
                        end
                    end

                    function get_share_world_info_button_style()
                        local count = 6

                        if not can_be_sync() then
                            count = count - 1
                        end

                        if not Eval('hasPid') then
                            count = count - 1
                        end

                        local width = count * (36 + 6)

                        return width .. 'px'
                    end

                    function open_folder(index)
                        local currentSelectedWorld = WorldList:GetSelectWorld(index)
                        if currentSelectedWorld and type(currentSelectedWorld) == 'table' and currentSelectedWorld.status and currentSelectedWorld.status == 2 then
                            _guihelper.MessageBox(L"请先下载世界")
                            return false
                        end

                        local worldpath = currentSelectedWorld.worldpath or ""
                        Map3DSystem.App.Commands.Call("File.WinExplorer", {filepath = worldpath, silentmode=true});
                    end

                    function set_default(name)
                        if name == 'content' then
                            page:FindControl('open_content'):SetDefault(true)
                        end

                        if name == 'search_text_online' then
                            page:FindControl('search_button_online'):SetDefault(true)
                        end

                        if name == 'search_text_offline' then
                            page:FindControl('search_button_offline'):SetDefault(true)
                        end
                    end
                ]]>
            </script>
            <style type="text/mcss" src="Mod/WorldShare/cellar/Theme/Mcss/Theme1.mcss">
                {
                    my_school_button = {
                        ["min-width"] = 100,
                        height  = 28,
                        color = '#ffffff',
                        background = "Texture/Aries/Creator/Theme/GameCommonIcon_32bits.png#208 89 21 21:8 8 8 8",
                    },
                    login_button = {
                        ["min-width"] = 100,
                        height = 28,
                        color = "#cccccc",
                        background = "Texture/Aries/Creator/Theme/GameCommonIcon_32bits.png;179 89 21 21:8 8 8 8",
                    },
                    user_area = {
                        float = "left",
                        width  = 158,
                        height = 450,
                    },
                    world_area = {
                        float = "left",
                        width  = 900,
                        height = 490,
                        ["padding-top"] = 5, 
                        ["padding-left"] = 20,
                        ["padding-right"] = 0,
                    },
                    add_server_text_field = {
                        textcolor = "#ffffff",
                        float = "left",
                        height = 30,
                        background = "Texture/Aries/Creator/Theme/GameCommonIcon_32bits.png;263 346 36 36:15 15 15 15",
                    },
                    share_selected_item = {
                        ["margin-right"] = 8,
                        width = 280,
                        height = 260,
                        background = "Texture/Aries/Creator/keepwork/worldshare_32bits.png;471 212 30 30:11 11 11 11",
                    },
                    share_unselect_item = {
                        ["margin-right"] = 8,
                        ["margin-bottom"] = 8,
                        ["padding-top"] = 4,
                        width = 280,
                        height = 260,
                        background = "Texture/Aries/Creator/keepwork/worldshare_32bits.png;435 212 30 30:11 11 11 11",
                    },
                    share_world_name = {
                        ["text-singleline"] = "true",
                        width = 220,
                        float = "left",
                        ["base-font-size"] = 16,
                        ["font-size"] = 16,
                        ["margin-top"] = 2,
                        ["text-align"] = "left",
                        color = "#000000",
                    },
                    project_id = {
                        position = "relative",
                        height = 17,
                        width = 85,
                        ["margin-left"] = 200,
                        ["margin-top"] = -27,
                        ["font-size"] = 11,
                        ["base-font-size"] = 11,
                        color = "#cccccc",
                        ["text-align"] = "center",
                        background = "Texture/Aries/Creator/Theme/GameCommonIcon_32bits.png;179 89 21 21:8 8 8 8"
                    },
                    share_world_info = {
                        ["text-singleline"] = "true",
                        float = "left",
                        ["margin-left"] = 0,
                        height = 18,
                        ["font-size"] = 12,
                        color = "#9e9e9e",
                    },
                    share_world_info_button = {
                        ["margin-left"] = 0,
                        ["margin-top"] = 3,
                    },
                    share_button = {
                        width = 36,
                        height = 37,
                        ["margin-right"] = 6,
                    },
                    status = {
                        float = "left",
                        padding = 8,
                        width = 16,
                        height = 16,
                        ["margin-top"] = 8,
                        ["margin-bottom"] = 8,
                        ["margin-left"] = 2,
                        ["margin-right"] = 4,
                    },
                    common_button = {
                        height = 30,
                        spacing = 20,
                        ["font-weight"] = "bold",
                        ["font-size"]   = 14,
                    },
                    nav_button = {
                        color = "#cccccc",
                        background = "",
                        ["margin-top"] = 0,
                        height=28,
                        background2 = "Texture/Aries/Creator/Theme/GameCommonIcon_32bits.png;179 89 21 21:8 8 8 8",
                    },
                    flat_button = {
                        color = "#cccccc",
                        ["margin-top"] = 0,
                        background = "Texture/Aries/Creator/Theme/GameCommonIcon_32bits.png;179 89 21 21:8 8 8 8",
                    },
                    link_big_event = {
                        ["background"] = "",
                        ["padding-left"] = 0,
                        ["padding-top"] = 0,
                        ["padding-right"] = 0,
                        ["padding-bottom"] = 0,
                        background = "",
                    },
                    big_event_item = {
                        ["margin-bottom"] = 20,
                        ["padding-left"] = 5,
                        ["padding-top"] = 5,
                        width  = 295,
                        height = 65,
                        ["background-color"] = "#454340",
                    },
                    event_title = {
                        ["base-font-size"] = 16,
                        ["font-size"] = 16,
                        ["margin-top"] = 2,
                        ["text-align"] = "left",
                        color = "#ffffff",
                    },
                    left_arrow = {
                        float = "left",
                        ["background-color"] = "#33ff33",
                        width = 18,
                        height = 18,
                        ["margin-top"] = 4,
                        background = "Texture/Aries/Creator/Theme/GameCommonIcon_32bits.png#223 148 18 18"
                    },
                    menu_select = {
                        width = 92,
                        height = 30,
                        background = "Texture/Aries/Creator/keepwork/worldshare_32bits.png;175 100 32 26:12 13 12 12",
                        ["margin-right"] = 8,
                    },
                    menu_unselect = {
                        width = 92,
                        height = 30,
                        background = "Texture/Aries/Creator/keepwork/worldshare_32bits.png;219 100 32 26:12 13 12 12",
                        ["margin-right"] = 8,
                    },
                    list_search_bar = {
                        float = 'left',
                        ['margin-left'] = 10,
                        ['margin-top'] = 0,
                        width = 316,
                        height = 30,
                    },
                    list_search_textfield = {
                        width = 266,
                        height = 30,
                        background = ''
                    },
                    list_search_button = {
                        position = 'relative',
                        align = 'right',
                        color = "#000000",
                        height = 30,
                        width = 57,
                        ['text-align'] = 'center',
                        ['margin-top'] = -32
                    },
                    list_search_button_click = {
                        postion = 'relative',
                        height = 30,
                        width = 57
                    },
                }
            </style>
            <kp:window width="920"
                       height="530"
                       icon_width="141"
                       icon='Texture/Aries/Creator/paracraft/paracraft_create_32bits.png#8 7 141 55'
                       onclose="close()">
                <div style="<%= header() %>" width="100%">
                    <div class="list_search_bar theme1_white1_textfield" style="<%= 'float: left;margin-left: 520px;' %>">
                        <input type="text"
                               name="content"
                               onfocusin='set_default'
                               class="list_search_textfield"
                               spacing="4"
                               EmptyText='<%=L"输入项目ID或课程ID或服务器地址"%>'
                               value=""/>
                        <div class="list_search_button">
                            <input type="button"
                                   name='open_content'
                                   class="list_search_button_click theme1_gray2_button"
                                   value='<%=L"打开"%>'
                                   onclick="go_to_url()" />
                        </div>
                    </div>
                </div>
                <div class="world_area">
                    <div style="height: 30px;margin-bottom: 3px;">
                        <div style="float:left;">
                            <!-- --------------- -->
                            <pe:if condition="<%= is_current_menu_select(1) %>">
                                <div class="menu_select" style="float:left">
                                    <input type="button" style="position: relative;width: 92px;height: 30px;background:" name="1" onclick="select_type"/>
                                    <div style="width: 20px;height: 13px;margin-left: 35px;margin-top: 10px;background: url(Texture/Aries/Creator/paracraft/paracraft_create_32bits.png#14 78 20 13)"></div>
                                </div>
                            </pe:if>
                            <pe:if condition="<%= not is_current_menu_select(1) %>">
                                <div class="menu_unselect" style="float:left">
                                    <input type="button" style="position: relative;width: 92px;height: 30px;background:" name="1" onclick="select_type"/>
                                    <div style="width: 20px;height: 13px;margin-left: 35px;margin-top: 10px;background: url(Texture/Aries/Creator/paracraft/paracraft_create_32bits.png#14 99 20 13)"></div>
                                </div>
                            </pe:if>
                            <pe:if condition="<%= is_signed_in() %>">
                                <!-- --------------- -->
                                <pe:if condition="<%= is_current_menu_select(2) %>">
                                    <div class="menu_select" style="float:left">
                                        <input type="button" style="position: relative;width: 92px;height: 30px;background:" name="2" onclick="select_type"/>
                                        <div style="width: 42px;height: 13px;margin-left: 25px;margin-top: 10px;background: url(Texture/Aries/Creator/paracraft/paracraft_create_32bits.png#62 78 42 13)"></div>
                                    </div>
                                </pe:if>
                                <pe:if condition="<%= not is_current_menu_select(2) %>">
                                    <div class="menu_unselect" style="float:left">
                                        <input type="button" style="position: relative;width: 92px;height: 30px;background:" name="2" onclick="select_type"/>
                                        <div style="width: 42px;height: 13px;margin-left: 25px;margin-top: 10px;background: url(Texture/Aries/Creator/paracraft/paracraft_create_32bits.png#62 99 42 13)"></div>
                                    </div>
                                </pe:if>
                                <!-- --------------- -->
                                <pe:if condition="<%= is_current_menu_select(3) %>">
                                    <div class="menu_select" style="float:left">
                                        <input type="button" style="position: relative;width: 92px;height: 30px;background:" name="3" onclick="select_type"/>
                                        <div style="width: 38px;height: 13px;margin-left: 25px;margin-top: 10px;background: url(Texture/Aries/Creator/paracraft/paracraft_create_32bits.png#124 77 38 13)"></div>
                                    </div>
                                </pe:if>
                                <pe:if condition="<%= not is_current_menu_select(3) %>">
                                    <div class="menu_unselect" style="float:left">
                                        <input type="button" style="position: relative;width: 92px;height: 30px;background:" name="3" onclick="select_type"/>
                                        <div style="width: 38px;height: 13px;margin-left: 25px;margin-top: 10px;background: url(Texture/Aries/Creator/paracraft/paracraft_create_32bits.png#124 98 38 13)"></div>
                                    </div>
                                </pe:if>
                            </pe:if>
                        </div>
                        <!-- search project -->
                        <pe:if condition="<%= is_signed_in() %>">
                            <div class="theme1_black_textfield" style="margin-top: 0;width: 220px;height: 30px;float: left;margin-left: 220px;">
                                <input type="text"
                                       name="search_text_online"
                                       style="textcolor: #ffffff;width: 220px;height: 30px;background: ''"
                                       spacing="4"
                                       EmptyText='<%=L"搜索列表项目"%>'
                                       onfocusin='set_default'
                                       onfocusout="search"
                                       value="<%= get_last_search_text() %>"/>
                                <div class="list_search_button">
                                    <input type="button"
                                           name='search_button_online'
                                           class="list_search_button_click theme1_gray2_button"
                                           value='<%=L"搜索"%>'
                                           onclick="search()" />
                                </div>
                            </div>
                        </pe:if>
                        <pe:if condition="<%= not is_signed_in() %>">
                            <div class="theme1_black_textfield" style="margin-top: 0;width: 220px;height: 30px;float: left;margin-left: 415px;">
                                <input type="text"
                                       name="search_text_offline"
                                       style="textcolor: #ffffff;width: 220px;height: 30px;background: ''"
                                       spacing="4"
                                       EmptyText='<%=L"搜索列表项目"%>'
                                       onfocusin='set_default'
                                       onfocusout="search"
                                       value="<%= get_last_search_text() %>"/>
                                <div class="list_search_button">
                                    <input type="button"
                                           name='search_button_offline'
                                           class="list_search_button_click theme1_gray2_button"
                                           value='<%=L"搜索"%>'
                                           onclick="search()" />
                                </div>
                            </div>
                        </pe:if>
                        <!-- create button -->
                        <div style="float:left;margin-left:10px;height: 37px;width:130px;margin-top: -3px;background: url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#264 46 38 34:12 12 14 12)">
                            <input type="button"
                                   style="position: relative;width: 130px;height: 37px;background:"
                                   onclick="create_new_world()"/>
                            <div style="float: left;margin-left: 28px;margin-top: 5px;width: 22px;height: 23px;background: url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#310 16 22 23)"></div>
                            <div style="float: left;margin-left: 3px;margin-top: 9px;width: 40px;height: 16px;background: url(Texture/Aries/Creator/paracraft/paracraft_create_32bits.png#197 37 40 16)"></div>
                            <div style=""></div>
                        </div>
                    </div>
                    <div style="height:440px;">
                        <pe:if condition="<%= is_list_refreshing() %>">
                            <div style="margin-left: 330px;margin-top: 140px;">
                                <div style="margin-left: 58px;margin-bottom: 20px;width: 104px;height: 109px;background:url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#500 15 104 109);background-animation:url(script/UIAnimation/CommonProgress.lua.table#WaitingSpin)"></div>
                                <div style="width: 226px;height: 23px;background: url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#447 137 226 23)"></div>
                            </div>
                        </pe:if>
                        <pe:if style="margin-top:10px;font-weight:bold;color:#ffffff" condition="<%= not is_list_refreshing() %>">
                            <pe:gridview 
                                RememberScrollPos="true"
                                AllowPaging="false"
                                VerticalScrollBarStep="80"
                                DefaultNodeHeight="270"
                                CellPadding="0"
                                ItemsPerLine="3"
                                name="gw_world_ds">
                                <Columns>
                                    <!--selected-->
                                    <pe:if condition='<%= be_selected()%>'>
                                        <div name='<%=Eval("index")%>' class="share_selected_item" style="padding-top: 6px;padding-left: 4px;">
                                            <pe:if condition="<%= has_rated() %>">
                                                <div style="position: relative;width: 70px;height: 36px;margin-top: -4px;margin-left: -4px;padding-top: 4px;padding-left: 6px;background: url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#356 136 70 36)">
                                                    <%= get_art_number()%>
                                                </div>
                                            </pe:if>
                                            <pe:if condition='<%= Eval("project") and tonumber(Eval("project")["visibility"]) == 1 %>'>
                                                <div style="position: relative;margin-left: 220px;width: 28px;height: 31px;background: url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#310 53 28 31)"></div>
                                            </pe:if>
                                            <div style="width: 268px;height: 248px;padding: 4px;background: url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#72 20 16 16:2 2 2 2)">
                                                <div style="width: 260px;height: 130px;background-color: #afafaf;">
                                                    <div style="position: relative;width: 260px;height: 130px;background: url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#394 211 32 32:9 9 9 9)"></div>
                                                    <div style="<%= 'width: 260px;height: 130px;background: url(' .. get_world_preview() .. ')' %>"></div>
                                                </div>
                                                <div style="position: relative; width: 32px;height: 32px;">
                                                    <pe:if condition='<%= get_world_status(1)%>'>
                                                        <div class="status" style="<%= get_world_status_icon(1) %>" tooltip='<%= get_world_status_tips()%>' />
                                                    </pe:if>
                                                    <pe:if condition='<%= get_world_status(2)%>'>
                                                        <div class="status" style="<%= get_world_status_icon(2) %>" tooltip='<%= get_world_status_tips()%>' />
                                                    </pe:if>
                                                    <pe:if condition='<%= get_world_status(3)%>'>
                                                        <div class="status" style="<%= get_world_status_icon(3) %>" tooltip='<%= get_world_status_tips()%>' />
                                                    </pe:if>
                                                    <pe:if condition='<%= get_world_status(4)%>'>
                                                        <div class="status" style="<%= get_world_status_icon(4) %>" tooltip='<%= get_world_status_tips()%>' />
                                                    </pe:if>
                                                    <pe:if condition='<%= get_world_status(5)%>'>
                                                        <div class="status" style="<%= get_world_status_icon(5) %>" tooltip='<%= get_world_status_tips()%>' />
                                                    </pe:if>
                                                    <pe:if condition='<%= not can_be_sync()%>'>
                                                        <div style="float:left;width:9px;height:32px;background:#fff" />
                                                    </pe:if>
                                                </div>
                                                <div style="margin-left: 20px;">
                                                    <div class="share_world_name">
                                                        <pe:if condition='<%= is_modifying() %>'>
                                                            <div class="list_search_bar" style="float: left;margin-left: 0px;width: 180px;height: 25px;">
                                                                <input type="text"
                                                                       onchange="update_temp_modify_worldname"
                                                                       class="list_search_textfield theme1_white_textfield"
                                                                       style="width: 145px;height: 25px;"
                                                                       value="<%= get_tagname() %>"
                                                                       spacing="4" />
                                                                <div class="list_search_button" style="height: 25px;width: 40px;font-size: 12px;base-font-size: 12px;margin-top: -26px;">
                                                                    <input type="button"
                                                                           class="list_search_button_click theme1_gray2_button"
                                                                           style="height: 25px;"
                                                                           DefaultButton="true"
                                                                           value='<%=L"保存"%>'
                                                                           onclick="covert_status" />
                                                                </div>
                                                            </div>
                                                        </pe:if>
                                                        <pe:if condition='<%= not is_modifying() %>'>
                                                            <%= get_world_text() %>
                                                            <pe:if condition="<%= Eval('hasPid') %>">
                                                                <div style="float:left;margin-left: 2px;" tooltip='<%= L"项目ID：" .. Eval("kpProjectId") %>'>
                                                                    <span style="color: #9e9e9e;">
                                                                        #<%= Eval('kpProjectId') or '' %>
                                                                    </span>
                                                                </div>
                                                            </pe:if>
                                                            <div onclick="covert_status"
                                                                tooltip="<%=Eval('text')%>"
                                                                style="float:left;margin-top:6px;margin-left:1px;background: url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#340 311 14 15);width: 10px;height: 12px;z-index: 10">
                                                            </div>
                                                        </pe:if>
                                                    </div>
                                                </div>
                                                <div style="margin-left: 20px;">
                                                    <div class="share_world_info">
                                                        <div style="float:left;width:198px;">
                                                            <%= get_world_date() %>
                                                        </div>
                                                        <div style="float: left;text-singleline: true;width: 20px;font-size: 12px;base-font-size: 12px;color: #9e9e9e;margin-top:6px;">
                                                            <%= 'v' .. get_world_version() %>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div style="margin-left: 20px;font-size: 12px;base-font-size: 12px;color: #9e9e9e;margin-top: 6px;">
                                                    <div style="float:left;" tooltip='<%= L"观看：" .. get_project_views() %>'>
                                                        <img src="Texture/Aries/Creator/keepwork/worldshare_32bits.png#383 181 16 12"
                                                            style="width: 16px;height: 12px;margin-top: 4px;" />
                                                        <div style="float:left;margin-left: 2px;">
                                                            <%= get_project_views() %>
                                                        </div>
                                                    </div>
                                                    <div style="float:left;margin-left: 8px;" tooltip='<%= L"点赞：" .. get_project_thumbs() %>'>
                                                        <img src="Texture/Aries/Creator/keepwork/worldshare_32bits.png#358 177 16 16"
                                                             style="width: 16px;height: 16px;" />
                                                        <div style="float:left;margin-left: 2px;">
                                                            <%= get_project_thumbs() %>
                                                        </div>
                                                    </div>
                                                    <div style="float:left;margin-left: 8px;" tooltip='<%= L"评论：" .. get_project_comments() %>'>
                                                        <img src="Texture/Aries/Creator/keepwork/worldshare_32bits.png#409 181 18 16"
                                                             style="width: 18px;height: 16px;margin-top: 3px;" />
                                                        <div style="float:left;margin-left: 2px;">
                                                            <%= get_project_comments() %>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="share_world_info_button" align="right" style="<%= 'width: ' .. get_share_world_info_button_style() .. ';margin-right: -10px;' %>">
                                                    <pe:if condition="<%= Eval('hasPid') %>">
                                                        <input type="button"
                                                               class="share_button"
                                                               style="<%= get_share_button('web') %>"
                                                               onclick="open_project"
                                                               tooltip="<%= L'项目ID：' .. Eval('kpProjectId') .. L'， 点击打开项目页' %>"
                                                               name='<%= Eval("index") %>' />
                                                    </pe:if>
                                                    <input type="button"
                                                           class="share_button"
                                                           style="<%= get_share_button('revision') %>"
                                                           onclick="selected_version"
                                                           tooltip="<%=L'切换版本' %>"
                                                           name='<%= Eval("index") %>' />
                                                    <!-- open current world folder -->
                                                    <input type="button"
                                                           class="share_button"
                                                           style="<%= get_share_button('folder') %>"
                                                           onclick="open_folder"
                                                           tooltip="<%=L'打开世界文件夹' %>"
                                                           name='<%= Eval("index") %>' />
                                                    <!-- delete -->
                                                    <input type="button"
                                                           class="share_button"
                                                           style="<%= get_share_button('delete') %>"
                                                           onclick='delete_world'
                                                           tooltip='<%=L"删除"%>'
                                                           name='<%=Eval("index")%>' />
                                                    <pe:if condition='<%= can_be_sync()%>'>
                                                        <!-- sync -->
                                                        <input type="button"
                                                               class="share_button"
                                                               style="<%= get_share_button('sync') %>"
                                                               onclick="sync"
                                                               tooltip='<%=L"同步"%>'
                                                               name='<%=Eval("index")%>' />
                                                    </pe:if>
                                                    <!-- enter -->
                                                    <input type="button"
                                                           class="share_button"
                                                           style="<%= get_share_button('enter') %>"
                                                           onclick="enter"
                                                           tooltip='<%=L"进入"%>'
                                                           name='<%=Eval("index")%>' />
                                                </div>
                                            </div>
                                        </div>
                                    </pe:if>
                                    <!--not selected-->
                                    <pe:if condition='<%= not be_selected() %>'>
                                        <div name='<%=Eval("index")%>' class="share_unselect_item" style="padding-left:8px;padding-top:8px;">
                                            <input type="button" style="position: relative;width:260px;height:260px;background:" name='<%=Eval("index")%>' onclick="switch_world" />
                                            <pe:if condition="<%= has_rated() %>">
                                                <div style="position: relative;width: 70px;height: 36px;margin-top: -6.8px;margin-left: -8px;padding-top: 4px;padding-left: 6px;background: url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#356 136 70 36)">
                                                    <%= get_art_number()%>
                                                </div>
                                            </pe:if>
                                            <pe:if condition='<%= Eval("project") and tonumber(Eval("project")["visibility"]) == 1 %>'>
                                                <div style="position: relative;margin-left: 220px;width: 28px;height: 31px;background: url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#310 53 28 31)"></div>
                                            </pe:if>
                                            <div style="width: 260px;height: 130px;background-color: #afafaf;">
                                                <div style="position: relative;width: 260px;height: 130px;background: url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#394 211 32 32:9 9 9 9)"></div>
                                                <div style="<%= 'width: 260px;height: 130px;background: url(' .. get_world_preview() .. ')' %>">
                                                    <pe:if condition="<%= has_username() %>">
                                                        <div style="width: 260px;height: 30px;margin-top: 100px;font-size: 12px;padding-top: 5px;padding-left: 4px;color: #ffffff;background-color: #000000a3">
                                                            <%= get_user_icon() %>
                                                            <%= get_username() %>
                                                        </div>
                                                    </pe:if>
                                                </div>
                                            </div>
                                            <div style="position: relative;width: 32px;height: 32px;">
                                                <pe:if condition='<%= get_world_status(1) %>'>
                                                    <div class="status" style="<%= get_world_status_icon(1) %>" tooltip='<%= get_world_status_tips()%>' />
                                                </pe:if>
                                                <pe:if condition='<%= get_world_status(2) %>'>
                                                    <div class="status" style="<%= get_world_status_icon(2) %>" tooltip='<%= get_world_status_tips()%>' />
                                                </pe:if>
                                                <pe:if condition='<%= get_world_status(3) %>'>
                                                    <div class="status" style="<%= get_world_status_icon(3) %>" tooltip='<%= get_world_status_tips()%>' />
                                                </pe:if>
                                                <pe:if condition='<%= get_world_status(4) %>'>
                                                    <div class="status" style="<%= get_world_status_icon(4) %>" tooltip='<%= get_world_status_tips()%>' />
                                                </pe:if>
                                                <pe:if condition='<%= get_world_status(5) %>'>
                                                    <div class="status" style="<%= get_world_status_icon(5) %>" tooltip='<%= get_world_status_tips()%>' />
                                                </pe:if>
                                                <pe:if condition='<%= not can_be_sync()%>'>
                                                    <div style="float:left;width:9px;height:32px;background:#fff" />
                                                </pe:if>
                                            </div>
                                            <div style="margin-left: 20px;">
                                                <div class="share_world_name">
                                                    <%= get_world_text() %>
                                                    <pe:if condition="<%= Eval('hasPid') %>">
                                                        <div style="float:left;margin-left: 2px;" tooltip='<%= L"项目ID：" .. Eval("kpProjectId") %>'>
                                                            <span style="color: #9e9e9e;">
                                                                #<%= Eval('kpProjectId') or '' %>
                                                            </span>
                                                        </div>
                                                    </pe:if>
                                                </div>
                                            </div>
                                            <div style="margin-left: 20px;">
                                                <div class="share_world_info">
                                                    <div style="float:left;width:198px;">
                                                        <%= get_world_date() %>
                                                    </div>
                                                    <div style="float: left;text-singleline: true;width: 20px;font-size: 12px;base-font-size: 12px;color: #9e9e9e;margin-top:6px;">
                                                        <%= 'v' .. get_world_version() %>
                                                    </div>
                                                </div>
                                            </div>
                                            <div style="margin-left: 20px;font-size: 12px;base-font-size: 12px;color: #9e9e9e;margin-top: 6px;">
                                                <div style="float:left;" tooltip='<%= L"观看：" .. get_project_views() %>'>
                                                    <img src="Texture/Aries/Creator/keepwork/worldshare_32bits.png#383 181 16 12"
                                                        style="width: 16px;height: 12px;margin-top: 4px;" />
                                                    <div style="float:left;margin-left: 2px;">
                                                        <%= get_project_views() %>
                                                    </div>
                                                </div>
                                                <div style="float:left;margin-left: 8px;" tooltip='<%= L"点赞：" .. get_project_thumbs() %>'>
                                                    <img src="Texture/Aries/Creator/keepwork/worldshare_32bits.png#358 177 16 16"
                                                         style="width: 16px;height: 16px;" />
                                                    <div style="float:left;margin-left: 2px;">
                                                        <%= get_project_thumbs() %>
                                                    </div>
                                                </div>
                                                <div style="float:left;margin-left: 8px;" tooltip='<%= L"评论：" .. get_project_comments() %>'>
                                                    <img src="Texture/Aries/Creator/keepwork/worldshare_32bits.png#409 181 18 16"
                                                         style="width: 18px;height: 16px;margin-top: 3px;" />
                                                    <div style="float:left;margin-left: 2px;">
                                                        <%= get_project_comments() %>
                                                    </div>
                                                </div>
                                            </div>
                                            <div style="margin-left: 20px;margin-top: 25px;height: 16px;float:left;font-size: 12px;">
                                                <pe:if condition="<%= get_school_name() ~= '' %>">
                                                    <img style="width: 19px;height: 16px;margin-right: 5px;" src="Texture/Aries/Creator/keepwork/worldshare_32bits.png#311 311 19 16" />
                                                    <%= get_school_name() %>
                                                </pe:if>
                                            </div>
                                            <div align="right" class="share_world_info_button"  style="margin-right: 12px;width:30px;height:30px;margin-top: -34px;">
                                                <!-- ENTER -->
                                                <input type="button"
                                                        class="share_button"
                                                        style="<%= get_share_button('enter') %>"
                                                        onclick="enter"
                                                        tooltip='<%=L"进入"%>'
                                                        name='<%=Eval("index")%>' />
                                            </div>
                                        </div>
                                    </pe:if>
                                </Columns>
                                <EmptyDataTemplate>
                                    <div style="margin:10px;font-weight:bold;">
                                        <%=L"暂无存档，请创建" %>
                                    </div>
                                </EmptyDataTemplate>
                                <FetchingDataTemplate>
                                    <div style="margin-top:10px;font-weight:bold;">
                                        <%=L"正在搜索, 请稍候 ... " %>
                                    </div>
                                </FetchingDataTemplate>
                                <PagerSettings Position="Bottom" />
                                <PagerTemplate AutoHidePager="true" style="margin-top: 8px;margin-left: 80px;">
                                    <form>
                                        <input type="button" name="pre" zorder="2" class="mc_light_grey_button_with_fillet" style="float:left;height: 20px;font-size: 13px;" value="<%= L'上一页' %>"/>
                                        <label name="page" style="color:#ffffff;height:18px;width: 50px;text-align: center;margin-top: -2px;"></label>
                                        <input type="button" name="next" zorder="2" class="mc_light_grey_button_with_fillet" style="float:left;height: 20px;font-size: 13px;" value="<%= L'下一页' %>"/>
                                    </form>
                                </PagerTemplate>
                            </pe:gridview>
                        </pe:if>
                    </div>
                </div>
            </kp:window>
        </pe:mcml>
    </body>
</html>
